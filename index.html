<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Akıllı Renk Paleti Oluşturucu</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        
        /* Renk kartı animasyonu */
        .color-card {
            transition: all 0.2s ease;
        }
        .color-card:hover {
            transform: translateY(-2px) scale(1.05);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        
        /* Slider özelleştirme */
        input[type=range] {
            -webkit-appearance: none; 
            background: transparent; 
        }
        
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 20px;
            width: 20px;
            border-radius: 50%;
            background: #4F46E5;
            cursor: pointer;
            margin-top: -8px; 
            box-shadow: 0 0 2px rgba(0,0,0,0.5);
        }
        
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 4px;
            cursor: pointer;
            background: #E5E7EB;
            border-radius: 2px;
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 min-h-screen flex flex-col">

    <!-- Header -->
    <header class="bg-white shadow-sm sticky top-0 z-10">
        <div class="max-w-7xl mx-auto px-4 py-4 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="bg-indigo-600 text-white p-2 rounded-lg">
                    <i class="fa-solid fa-palette text-xl"></i>
                </div>
                <h1 class="text-xl font-bold text-slate-800 tracking-tight">Palette Master</h1>
            </div>
            <button onclick="document.getElementById('fileInput').click()" class="bg-indigo-600 hover:bg-indigo-700 text-white px-5 py-2 rounded-full text-sm font-medium transition-colors shadow-sm flex items-center gap-2">
                <i class="fa-solid fa-cloud-arrow-up"></i> Resim Yükle
            </button>
            <input type="file" id="fileInput" accept="image/*" class="hidden" onchange="handleImageUpload(event)">
        </div>
    </header>

    <!-- Main Content -->
    <main class="flex-grow max-w-7xl mx-auto px-4 py-8 w-full grid grid-cols-1 lg:grid-cols-3 gap-8">
        
        <!-- Sol Panel: Resim ve Kontroller -->
        <div class="lg:col-span-1 space-y-6">
            
            <!-- Resim Önizleme -->
            <div class="bg-white p-4 rounded-2xl shadow-sm border border-slate-100">
                <h2 class="text-sm font-semibold text-slate-500 mb-3 uppercase tracking-wider">Orijinal Görsel</h2>
                <div id="imageContainer" class="w-full h-64 bg-slate-100 rounded-xl flex items-center justify-center overflow-hidden border-2 border-dashed border-slate-200 relative group">
                    <img id="previewImage" class="hidden w-full h-full object-contain" alt="Yüklenen Resim">
                    <div id="uploadPlaceholder" class="text-center p-6">
                        <i class="fa-regular fa-image text-4xl text-slate-300 mb-2"></i>
                        <p class="text-slate-400 text-sm">Bir resim seçin veya sürükleyin</p>
                    </div>
                </div>
            </div>

            <!-- Kontroller -->
            <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 opacity-50 pointer-events-none transition-all duration-300" id="controlsPanel">
                <div class="mb-6">
                    <div class="flex justify-between items-center mb-2">
                        <label class="text-sm font-semibold text-slate-700">Benzerlik Toleransı</label>
                        <span id="toleranceValue" class="bg-indigo-100 text-indigo-700 text-xs font-bold px-2 py-1 rounded">20</span>
                    </div>
                    <input type="range" id="toleranceRange" min="1" max="150" value="20" class="w-full" oninput="updateTolerance(this.value)">
                    <p class="text-xs text-slate-400 mt-2">Değeri artırmak daha fazla benzer rengi birleştirir ve paleti sadeleştirir.</p>
                </div>

                <div class="grid grid-cols-2 gap-4 bg-slate-50 p-4 rounded-xl border border-slate-100 mb-6">
                    <div class="text-center">
                        <p class="text-xs text-slate-500 mb-1">Bulunan Renk</p>
                        <p id="originalCount" class="text-xl font-bold text-slate-700">-</p>
                    </div>
                    <div class="text-center border-l border-slate-200">
                        <p class="text-xs text-slate-500 mb-1">Kalan Renk</p>
                        <p id="finalCount" class="text-xl font-bold text-indigo-600">-</p>
                    </div>
                </div>

                <button onclick="downloadPalette()" class="w-full bg-slate-800 hover:bg-slate-900 text-white py-3 rounded-xl font-medium transition-all shadow-lg shadow-slate-200 flex items-center justify-center gap-2">
                    <i class="fa-solid fa-download"></i> Paleti PNG Olarak İndir
                </button>
            </div>
        </div>

        <!-- Sağ Panel: Palet Sonucu -->
        <div class="lg:col-span-2">
            <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 min-h-[500px]">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-lg font-bold text-slate-800">Oluşturulan Palet</h2>
                    <div id="loadingIndicator" class="hidden flex items-center gap-2 text-indigo-600 text-sm font-medium">
                        <i class="fa-solid fa-circle-notch fa-spin"></i> İşleniyor...
                    </div>
                </div>

                <!-- Palet Grid -->
                <div id="paletteGrid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4">
                    <!-- Renkler buraya JS ile eklenecek -->
                    <div class="col-span-full text-center py-20 text-slate-400">
                        <i class="fa-solid fa-wand-magic-sparkles text-3xl mb-3 text-slate-300"></i>
                        <p>Henüz bir palet oluşturulmadı.</p>
                    </div>
                </div>
            </div>
        </div>

    </main>

    <!-- Canvas (Gizli, işlem ve indirme için) -->
    <canvas id="processCanvas" class="hidden"></canvas>
    <canvas id="downloadCanvas" class="hidden"></canvas>

    <script>
        const fileInput = document.getElementById('fileInput');
        const previewImage = document.getElementById('previewImage');
        const uploadPlaceholder = document.getElementById('uploadPlaceholder');
        const controlsPanel = document.getElementById('controlsPanel');
        const paletteGrid = document.getElementById('paletteGrid');
        const originalCountEl = document.getElementById('originalCount');
        const finalCountEl = document.getElementById('finalCount');
        const toleranceRange = document.getElementById('toleranceRange');
        const toleranceValue = document.getElementById('toleranceValue');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const processCanvas = document.getElementById('processCanvas');
        const ctx = processCanvas.getContext('2d');

        let rawColors = []; // Tüm pikseller (optimize edilmiş)
        let uniqueColors = []; // Benzersiz ham renkler
        let currentPalette = []; // Filtrelenmiş sonuç
        let processingTimeout;

        // Resmi Yükle
        function handleImageUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                previewImage.src = e.target.result;
                previewImage.classList.remove('hidden');
                uploadPlaceholder.classList.add('hidden');
                
                // Resim yüklendiğinde analizi başlat
                previewImage.onload = function() {
                    extractColors(previewImage);
                    controlsPanel.classList.remove('opacity-50', 'pointer-events-none');
                }
            };
            reader.readAsDataURL(file);
        }

        // Renkleri Çıkar (İlk analiz)
        function extractColors(img) {
            loadingIndicator.classList.remove('hidden');
            
            // UI bloklamamak için kısa bir gecikme
            setTimeout(() => {
                // Performans için resmi küçük bir boyuta çekip tarıyoruz (Max 150px)
                const maxSize = 150;
                let w = img.naturalWidth;
                let h = img.naturalHeight;
                
                if (w > h) {
                    if (w > maxSize) { h *= maxSize / w; w = maxSize; }
                } else {
                    if (h > maxSize) { w *= maxSize / h; h = maxSize; }
                }

                processCanvas.width = w;
                processCanvas.height = h;
                ctx.drawImage(img, 0, 0, w, h);

                const imageData = ctx.getImageData(0, 0, w, h).data;
                rawColors = [];

                // Her pikseli al (Alfa kanalı 0 olanları atla)
                for (let i = 0; i < imageData.length; i += 4) {
                    const r = imageData[i];
                    const g = imageData[i + 1];
                    const b = imageData[i + 2];
                    const a = imageData[i + 3];

                    if (a > 128) { // Şeffaf olmayanlar
                        rawColors.push({ r, g, b, hex: rgbToHex(r, g, b) });
                    }
                }

                // Tamamen aynı olan renkleri baştan ele (Set kullanarak)
                const seen = new Set();
                uniqueColors = [];
                rawColors.forEach(c => {
                    if (!seen.has(c.hex)) {
                        seen.add(c.hex);
                        uniqueColors.push(c);
                    }
                });

                originalCountEl.innerText = uniqueColors.length;
                
                // İlk filtrelemeyi yap
                processPalette();
            }, 50);
        }

        // Slider değiştiğinde çalışır
        function updateTolerance(val) {
            toleranceValue.innerText = val;
            clearTimeout(processingTimeout);
            // Kullanıcı kaydırmayı bitirene kadar bekle (Debounce)
            processingTimeout = setTimeout(() => {
                processPalette();
            }, 300);
        }

        // Ana Algoritma: Renkleri Birleştir
        function processPalette() {
            loadingIndicator.classList.remove('hidden');
            const threshold = parseInt(toleranceRange.value);

            setTimeout(() => {
                currentPalette = [];
                
                // Basit bir kümeleme mantığı (Greedy Clustering)
                // Renkleri gez, eğer mevcut paletimdeki bir renge çok benziyorsa ekleme.
                
                // Önce renkleri "önemine" göre sıralamak iyi olabilir ama
                // burada basitlik için sırayla gidiyoruz.
                
                for (let i = 0; i < uniqueColors.length; i++) {
                    const color = uniqueColors[i];
                    let isSimilar = false;

                    for (let j = 0; j < currentPalette.length; j++) {
                        const existing = currentPalette[j];
                        const dist = colorDistance(color, existing);
                        
                        if (dist < threshold) {
                            isSimilar = true;
                            break;
                        }
                    }

                    if (!isSimilar) {
                        currentPalette.push(color);
                    }
                }

                finalCountEl.innerText = currentPalette.length;
                renderPaletteDOM();
                loadingIndicator.classList.add('hidden');
            }, 10);
        }

        // Renk Uzaklığı (Euclidean Distance in RGB)
        function colorDistance(c1, c2) {
            return Math.sqrt(
                Math.pow(c1.r - c2.r, 2) + 
                Math.pow(c1.g - c2.g, 2) + 
                Math.pow(c1.b - c2.b, 2)
            );
        }

        function rgbToHex(r, g, b) {
            return "#" + ((1 << 24) + (r << 16) + (g << 8) + b).toString(16).slice(1).toUpperCase();
        }

        // Ekrana Çiz
        function renderPaletteDOM() {
            paletteGrid.innerHTML = '';
            
            // Eğer çok fazla renk varsa ilk 100 tanesini gösterip uyarabiliriz ama 
            // filtre zaten azaltıyor.
            
            currentPalette.forEach(color => {
                const hex = color.hex;
                // Yazı rengi için basit parlaklık kontrolü
                const brightness = (color.r * 299 + color.g * 587 + color.b * 114) / 1000;
                const textColor = brightness > 128 ? 'text-slate-800' : 'text-white';

                const div = document.createElement('div');
                div.className = `color-card rounded-xl p-4 flex flex-col justify-end h-32 relative cursor-pointer group`;
                div.style.backgroundColor = hex;
                div.onclick = () => copyToClipboard(hex);
                
                div.innerHTML = `
                    <div class="absolute inset-0 bg-black opacity-0 group-hover:opacity-10 transition-opacity rounded-xl"></div>
                    <div class="z-10 bg-white/20 backdrop-blur-md rounded-lg p-2 flex justify-between items-center opacity-0 group-hover:opacity-100 transition-opacity ${textColor}">
                        <span class="font-mono text-xs font-bold">${hex}</span>
                        <i class="fa-regular fa-copy text-xs"></i>
                    </div>
                `;
                paletteGrid.appendChild(div);
            });
        }

        function copyToClipboard(text) {
            const tempInput = document.createElement("input");
            tempInput.value = text;
            document.body.appendChild(tempInput);
            tempInput.select();
            document.execCommand("copy");
            document.body.removeChild(tempInput);
            
            // Ufak bir bildirim (opsiyonel)
            alert(text + " kopyalandı!");
        }

        // Paleti PNG olarak indir
        function downloadPalette() {
            if (currentPalette.length === 0) return;

            const downloadCanvas = document.getElementById('downloadCanvas');
            const dCtx = downloadCanvas.getContext('2d');
            
            // Grid hesabı
            const total = currentPalette.length;
            const cols = Math.ceil(Math.sqrt(total));
            const rows = Math.ceil(total / cols);
            
            const boxSize = 200; // Her bir renk kutusunun piksel boyutu
            const headerHeight = 100; // Başlık alanı
            
            downloadCanvas.width = cols * boxSize;
            downloadCanvas.height = (rows * boxSize) + headerHeight;

            // Arka plan
            dCtx.fillStyle = "#ffffff";
            dCtx.fillRect(0, 0, downloadCanvas.width, downloadCanvas.height);

            // Başlık Yazısı
            dCtx.fillStyle = "#1e293b";
            dCtx.font = "bold 40px Inter, sans-serif";
            dCtx.fillText("Renk Paleti", 40, 65);
            
            dCtx.font = "24px Inter, sans-serif";
            dCtx.fillStyle = "#64748b";
            dCtx.fillText(`${total} Renk Çıkarıldı`, 300, 65);

            // Renkleri Çiz
            currentPalette.forEach((color, index) => {
                const x = (index % cols) * boxSize;
                const y = Math.floor(index / cols) * boxSize + headerHeight;
                
                // Renk kutusu
                dCtx.fillStyle = color.hex;
                dCtx.fillRect(x, y, boxSize, boxSize);
                
                // Hex kodu yazısı (altta şerit)
                dCtx.fillStyle = "rgba(0,0,0,0.3)";
                dCtx.fillRect(x, y + boxSize - 50, boxSize, 50);
                
                dCtx.fillStyle = "#ffffff";
                dCtx.font = "bold 24px monospace";
                dCtx.textAlign = "center";
                dCtx.fillText(color.hex, x + (boxSize/2), y + boxSize - 18);
            });
            dCtx.textAlign = "start"; // Reset

            // İndir
            const link = document.createElement('a');
            link.download = 'renk-paleti.png';
            link.href = downloadCanvas.toDataURL();
            link.click();
        }
    </script>
</body>
</html>

